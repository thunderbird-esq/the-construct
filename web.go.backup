// Web client with device-adaptive Matrix intro
package main

import (
	"log"
	"net"
	"net/http"
	"strings"
	"github.com/gorilla/websocket"
)

var upgrader = websocket.Upgrader{CheckOrigin: checkWebSocketOrigin}

func checkWebSocketOrigin(r *http.Request) bool {
	origin := r.Header.Get("Origin")
	if origin == "" || Config.AllowedOrigins == "*" { return true }
	for _, a := range strings.Split(Config.AllowedOrigins, ",") {
		if strings.TrimSpace(a) == origin { return true }
	}
	return false
}

func filterTelnetIAC(data []byte) []byte {
	result := make([]byte, 0, len(data))
	for i := 0; i < len(data); {
		if data[i] == 255 && i+1 < len(data) {
			switch data[i+1] {
			case 255: result = append(result, 255); i += 2
			case 251, 252, 253, 254: i += 3
			case 250: i += 2; for i < len(data) && !(data[i] == 255 && i+1 < len(data) && data[i+1] == 240) { i++ }; i += 2
			default: i += 2
			}
		} else { result = append(result, data[i]); i++ }
	}
	return result
}

func startWebServer(w *World) {
	mux := http.NewServeMux()
	mux.HandleFunc("/", serveHome)
	mux.HandleFunc("/ws", handleWebSocket)
	mux.HandleFunc("/health", handleHealth)
	log.Printf("Web Portal active on http://0.0.0.0:%s", Config.WebPort)
	http.ListenAndServe("0.0.0.0:"+Config.WebPort, mux)
}

func handleHealth(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	w.Write([]byte(`{"status":"healthy","version":"1.36.0","service":"matrix-mud"}`))
}

func serveHome(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "text/html; charset=utf-8")
	w.Write([]byte(htmlClient))
}

func handleWebSocket(w http.ResponseWriter, r *http.Request) {
	ws, _ := upgrader.Upgrade(w, r, nil)
	if ws == nil { return }
	defer ws.Close()
	tcpConn, err := net.Dial("tcp", "localhost:"+Config.TelnetPort)
	if err != nil { ws.WriteMessage(websocket.TextMessage, []byte("Connection failed\r\n")); return }
	defer tcpConn.Close()
	go func() {
		buf := make([]byte, 4096)
		for { n, e := tcpConn.Read(buf); if e != nil { return }; if f := filterTelnetIAC(buf[:n]); len(f) > 0 { if ws.WriteMessage(websocket.TextMessage, f) != nil { return } } }
	}()
	for { _, m, e := ws.ReadMessage(); if e != nil { break }; tcpConn.Write(m) }
}


const htmlClient = `<!DOCTYPE html>
<html>
<head>
<title>The Construct</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
<style>
@font-face{font-family:'Glass TTY VT220';src:url('https://raw.githubusercontent.com/svofski/glasstty/master/Glass_TTY_VT220.ttf') format('truetype')}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;background:#000;overflow:hidden;position:fixed}
#app{display:flex;flex-direction:column;height:100dvh;height:100vh;width:100%}
#crt{flex:1;min-height:0;position:relative;margin:2px;border-radius:6px;background:#020202;box-shadow:0 0 30px rgba(0,255,65,0.06);overflow:hidden}
#terminal{position:absolute;top:2px;left:2px;right:2px;bottom:2px}
.xterm{height:100%!important}.xterm-screen{height:100%!important}
.xterm .xterm-cursor-block{background-color:#33ff33 !important;box-shadow:0 0 8px #33ff33,0 0 16px #22dd22 !important}
.xterm-cursor-blink{animation:phosphor-blink 0.7s steps(1) infinite !important}
@keyframes phosphor-blink{0%,40%{opacity:1}41%,100%{opacity:0.1}}
#scanlines{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.04) 0px,rgba(0,0,0,0.04) 1px,transparent 1px,transparent 2px)}
#input-bar{background:#050505;padding:4px;border-top:1px solid #111;display:flex;gap:4px}
#input{flex:1;padding:8px;font-size:16px;font-family:'Glass TTY VT220',monospace;background:#020202;border:1px solid #0a0;border-radius:3px;color:#0f0;outline:none}
#send-btn{padding:8px 12px;background:#0a0;border:none;border-radius:3px;color:#000;font-family:'Glass TTY VT220',monospace;font-weight:bold}
#controls{display:flex;flex-wrap:wrap;gap:2px;padding:3px;background:#030303}
.qbtn{flex:1;min-width:38px;padding:6px 2px;background:#080808;border:1px solid #181818;border-radius:3px;color:#0a0;font-family:'Glass TTY VT220',monospace;font-size:9px;text-align:center}
.qbtn:active{background:#0a0;color:#000}
@media(min-width:600px){#controls{display:none}}
</style>
</head>
<body>
<div id="app">
<div id="crt"><div id="terminal"></div><div id="scanlines"></div></div>
<div id="controls">
<div class="qbtn" ontouchend="cmd('n')">N</div><div class="qbtn" ontouchend="cmd('s')">S</div><div class="qbtn" ontouchend="cmd('e')">E</div><div class="qbtn" ontouchend="cmd('w')">W</div>
<div class="qbtn" ontouchend="cmd('look')">LOOK</div><div class="qbtn" ontouchend="cmd('inv')">INV</div><div class="qbtn" ontouchend="cmd('get')">GET</div><div class="qbtn" ontouchend="cmd('score')">SCORE</div>
</div>
<div id="input-bar"><input type="text" id="input" placeholder=">" autocomplete="off" autocapitalize="off" enterkeyhint="send"/><button id="send-btn" onclick="sendInput()">SEND</button></div>
</div>
<script>
const artDesktop = [
"                                                                  ;;++++;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;",
"                                                                 ;+++;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;",
"                                                                 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;;;;;;;;;;;;;;;; ;;;;;;;;;",
"                                                                 ;+;                                                           ;;",
"                                                                  ;;;;  .. .   .                                          .   .;",
"                                                                  ;+;;              ;;;; ;;;;;;;;;;;;;;;;  ;;;;;;        ;.  ;;;;",
"                                                                  ;*+;:.; ;.  ;;;;+#@##*;*##+*@@#*+#*+*#*;+#@@@@#+;..    ;;:.:+;;+*+;",
"                                                                  ;*;;:.; ;   ;  ;;+;;;;.+;+;;;*;;;;;;;*;;++;;;;+*  ;    ;;; ;;;;**##*;",
"                                                                  ;+;;  ; ;      ;+;;; ;;+;+;+;*;;;+*;+;+;*+****;*;      ;.   .;;*+;;*+",
"                                                                  ;++;::; ;.. ...;++;;+;+;;+;;;*;;:+;*;+;.++;;;;;+;..  . ;;:..;;;+++;++",
"                                                                  ;+;;;;; ; ; ; ;;+*#*++;+*#;;***;;;*+*;  ;***#**+;     ;;;; ;:;;++;;;;",
"                                                                  ;+:;  ;;;;;;;;;;;  ; ;   ;      ;;;   ;          ;;;;;;; ; ;.; +**+;;",
"                                                                  ;*+;;;;;;+;:;+;:;::++;:++;.:;;;;;;+;::;;:;:.:;;.;;;::::;;;.;++; ;;;;;",
"                                                                  ;+;;;;;;..; ;.;;  ;;;  ..  .......;;;;;;;;; ;;; ;;:... .;;;;;;;",
"                                                                  ;+:    ;;+;;;++*+;  ;;++++;;;;;;;;;;;;;;;;;;++++;;;;;+;;;    ;+;;++;",
"                                                                  ;*;;;;;;:;.;;;;;;;;;;;;;;;;;+++*******+++++;;;;;;;;;;;;;+; ;;;;#;;;;;                                                    ;;;",
"                                                                  ;*;;:;;;: ;+;;**;;:;;;;***;*;;+*+*******+++***;;+++++++;;; ;:;;*;;;;                                                      .",
"                                                                  ;+;;  ;;;;;.;;++;+++++;+++;*;         ;    *#*;;+******;.  ;.;**+;;                                                      ;;;",
"                                                                  ;++;:;; ;;;:;;*;;;;;;;;;**;+ ;;;;;;    . . *#*;+;      ;;. ;+;+*;;;;  ;",
"                                                                  ;+;;;;;  ;;;+;;+;;.:.;++;;+* ;;+**+;  ;;;;;*#;+*;;.    ;;;;;;;+*;;;;  ;",
"                                                                   ;.   ;;+; ;;;;+;;;+;;;;:+;+ ;;+++;+       +*+;+;      ; ;   ;;+ ;;;  ;",
"                                                                  ;+;;;;;;; .;+;;*;;;;; ++;;+*;;.;;;;+       *#;+*;      ;;;.;;;;+;;+;  ;",
"                                                                  ;+;;;;;;.  ;+;;+;;;;;;;;;;**;;;;;;;;  ;;   *#;**; ;;; ;+;;;;;;++ ;+;; ;",
"                                                                  ;+.     ;;; ;;;;;;;;;;;;:;+*      ;;       +*+;+;      ;     ;;; ;;;                        ;;",
"                                                                  ;+;;;;;.;+;.;;+++++;;;;;;;+*;;;. :;        +#;+*;     ;;;; ;;;;+ ;;;; ;",
"                                                                  ;++;;+;;;;;;;;+++++++++++;+*;;;;  ;        +#;+*;     ;+;; ;; ;+ ++   ;                     ;;",
"                                                                  ;+:  .; ;:; ;;+;++;++;;;:;++;;;::;;        +*+++;     ;;    . ;; ;+   ;",
"                                                                  ;++;:+; ;+;.;;++++++++++++++ ;;;;;         +**++      ;;;; ;; ;; ;+   ;",
"                                                                  ;+;;;;;;;;;;;;;;;;;;;;;;;;++  ;;;          +*;*+      ;;;;;;;;;;;;+;; ;",
"                                                                  ;;.   ; ;   ;;:....... . ;;+               ;+.;;       ;       ;;:+",
"                                                                  ;+;;;;;;;;;;;;;;+++;;;;;;;;;;;             ;*;++      ;+;;;;;;;;;++ ;",
"                                                                  ;++;;;;;;;;;;;+++***+;;;;;;;:;             ;*;++      ;+;;.;+ +;;++ ;",
"                                                                  ;+.  .;;;;;;;+#*++++;;;;;;;  ;;            ;+:+;      ;;   ;. .;;.;",
"                                                                  ;+;;;;;;; ;+;+;    ;;+;;;;;; ;;            ;+;+;      ;+;;;;;;;;;;+ ;",
"                                                                  ;++.;+;;; ;+++;     ;++;++;..;;            ;+++;      ;++;.;+.+;;++",
"                                                                  ;+: ;:;;  ;+;+      ;;;:;;;;.;;            ;+;+;      ;;.  ;. .;;.+",
"                                                                  ;++.;+;;  ;+++;     ;;;;+;;;;;;            ;+++;      ;;:; ;; :;;++ ; ;",
"                                                                  ;+;;;;;; ;;;+;;;    ;;++;   ;;;            ;+;+;      ;;;;.;; :;;++ ; ;",
"                                                                  ;;.;; ;;;;;   ;;                           ;;.;; ;;;; ;; ; ;.  ;;.;",
"                                                                  ;;;;;;;;;;;;;;;+                           ;+;;;;;++; ;;;;;;; .;;;; ;;;",
"                                                                  ;;+.:;;;;;::.;;+               ;+**+;      ;++; ;;;++ ;;+; ;; :;;:; ;.",
"                                                                  ;;: ;.;;;;;  ;;+               ;+++;;;     ;;;;  .;;; ;;.; ;.  ;;.; ;",
"                                                                  ;+;;;.;;;;.  ;;;    ;;+++;  ;; ;;++;;;     ;;.;  .;;  ;;.; ;;;.;;.; ;",
"                                                                  ;++.;:;.;:. .:;;    ;+;;++  ;+    ;;;;     ;;+; :;;;  ;;;..;+ :;;:; ;",
"                                                                  ;++;...  .   ;;;    ;+;;;;  ;;;;;   ;      ;;:.  .;;  ;;:; ;: .;;.; ;",
" ;;                         ;                                     ;++;.:; ..    +;    ;++++;                 ;;.. ..;;  ;;:; ;; .;;:; ;             ;",
"                    ;                                             ;++.:;;;;;;:.;;;;    ;;;;                  ;;+;;;;;;  ;;+:.;+.:;;:; ;.                                                       ;",
"                                                                  ;+;;;;;;;;;;;;                            ;*;;+;;;;;  ;;;;;;;; ;;.; ;                                            ;;         ;        ;",
";;;;;;;;;;;;;;    ;;       ;;; ;;;    ;;; ;;; ;;     ;;           ;;  ; ;;;;;;               ;;; ;;;;;;;;;;;;;+;;+***+;++;;; ;. .;; ; ; ;                                          ;                  ;;",
".;;;  .;   ;;;;            ;;; ;;;;   ;;;;;;; ;                   ;+;;;;;;+*+;;+;+++++*+++++++;+;;;;++++++;;;   ;;;;;;;;;;;;.;; ;; .; ; ;           ;            ;;;",
"  .           ;           ;;                                      ;++.:;;;+++++++;;;;;;;;;;;;;;;;;::;;;;;;:;:;:::;;;;;:;;;;; ;; ;; ; ;; ;                        ;.;                          ;.;",
"              ;                       ..  ;;          ;           ;;: ...;;+++++;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;.:...... .  .; ;:; ;    ; ;                        ; ;    ;;             ;;;       ;;;;;;;",
":.:.  ..  ....;  ;;              ;;;;;;;  ;;;     ;               ;++;++;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:;;;;;;;;;;+;.;+;;;  ; ;;;           ;                     ;  ;      ;;;         ..;:   .",
"...          ;; ;;;;                                              ;;;;;;;;                 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;:;;;; ; ;;;                               ;;           .          ;;;;;",
"             ;  ;;;:           ;;;;;;;;    ;    ;;;  ;     ;      ;;. ..;;   ; ;            ;                ;; ;       ;;:; ;;;; ; ; ;;;                                      ;          ;;;;      ;",
"::::..::..:::;; ;;;; .          .                                 ;;+;++;;   ;.;          ;.;                ;;;;       ;++;.;+;; ; ;;;;;          .;                      ;;..             .   . ..  ;;",
";;;;;;;;;;;;;;  ;.; ;                           ;;                ;;;;;;;;   ; ;          ; ;                ;;;;       ;+;;;;;+; ; ;;;;;         ;;;                      ;;                  ;;;;;  ;;",
"             ;;;;.;                                               ;;    ;;  ;;;;         ;;;;                ;;;;       ;; ; ;.;; ; ;;;;;                         ;;;;;;;;;;; ; ;;;;;; ;;;;;;;",
";;;;;;;;;;;;;; ...;                           ;                   ;;;;;;;+; ;;;;         ;+;+                ;;;;       ;+;;;;;;; ; ;;;;;    ;;;;;                . ;;;;;;;;;;; ;..;;;;;;;;;;;;;+++++;++",
";:;; .;;..;;;;; ; ;              ; ;          ;                   +;;;;+;+; ;;;;         ;+;+                ;;;;       ;*;;.;+;; ;.;;;;                         ;;;;;;;;;; ;;;  :.:;..;;;;;;; ;++++++++",
"             ; ;;;;;;;;    ;    ;                ;                ;;.  .;;; ;;;;      ;  ;;;;                 ; ;       ;+:; ;:;; ; ;;;;                             ;;;;;; ;.;.;;;;   ;;;;     ;;;;;;;;",
";:;:..::..::;;  ;+;  .      .  ;;;;;  .                     .     +;;:;;;+; ;;;;         ;+;+                ;;;;       ;++;:;;;; ;:;;;;;                                   ;.;            .;.:::.;;;; :",
";;;;;;;;;;;;;;;;;;;;;;;     ;;;;;;;;;;;;             ;;    ;;;  ; +;;;;;;+; ;;;;      ;  ;+++                ;;;;       ;+;;;;;;; ; ;;;;;   ;;;;    ;                     ; ;;;          ..;;;;;;;;;.:.;",
"             ;                                                    +;.  .;;  ;;;;         ;;;;                ;;;;       ;;   ;:;; ; ;;;;;           ;                                                  ;",
";;;;;;;;;;;;;;  ;          .                                      ++;;;;;+; ;;;;         ;+++                ;;;;       ;+;;:;;;; ;:;;;+;   ;;;                       ;;;     . ....;;;;;;;;;  ;;;;;;;;+",
";;;;;;;;..;;;;    ;  ;;                                           ++;;;;;+; ;;;;         ;+;+                ;;;;       ;+;;;;;+; ;;;;;+;         ;;;                  .     ;;;;;;;;;;;;;;;;;;;;.;;..;;",
"            ;                                                     ;;. ..;;   ;;          ;; ++************++;;; ;       ;;   ;;;; ; ;;;;;                                  ;;;;;;;;;                   .",
";;;;;;;;.::.;;; ;;;      ;;     .    ;;               ;  ;;       ++;;;;;;                ;;++++++++++++++++; ;+;;;;;;;;;+;;;;;+; ;.;+;+;    ;  ;;;;;      ;;;;;;;;;   .:::::;;::+:;+;:;;. ;;;;;;;;;...+",
".;+;.;;:;;;:.   ;.;                    ;   . .                    ++;;;+;;;;;;++;;;;;;;;;;;         ;;;;;;;     :;;;:::;.;+;:;++;    +;+;   ;.                    ..   ;;;;;;;;;;;;;;;;;;; ;;:::..::. ..",
"      .;         ;          .   .;          ;;        ;;          +;: .:.;++++++++++++++;++;;;;;;;;;;;;;;;++++;;         ;;; ;++; ;; +;+    ;                                              ;;;..:.::....",
"::::.;;;;  ..:;;               ; ;                                +;+;+++;;+++;++++++++;:++;:;+;;;;;++;;;;;++:;;;;;;;;;;;;+;;;++; ;.;+;+                                            .          ::.::::..",
";;;;;;;;  ..;;;;                                     ;;           ++;;;;;++*++++++++++++++;;;+++++;;++;;;;;;;;;;;++++;;;;;;;;;;+; ;.;++*         ; ;;     ;;;;;;;;;;;             ;;;; ;    . ;;;;;;;;;.",
"              ;;    ;;     ;;;                                    ;;    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;+++;;++;.; ;+;; ; ;+;+                                                              ;:",
";;;;;;;;;;;;.;; ;;;  ;;;                                          ++;;;;;;               ;;;;                ;;;;       ;+;;;;;+; ;.;++*                                 .      .  ;.  .:;  ...; ;;;  ;.",
".;;;.;;;;:;;;;  ;.;  ..               ;;                          +++;++;;               ;;;;                ;;;;       ;++;.;;+; ;. ++*    ;;;;;;;                     ;;;;;;;;;  ;;;;;;; ;;;    ..  ;:",
"     ;;; . ;     ;; ;;;                                           ;;.  .;;               ;;;;                ;; ;       ;+.; ;+*; ;  +++                                                               ;",
"  .     .:;;;;;                                                   +;;;;;;;               ;;;;                 ;.;       ;+;;;;;*; ;. +++                                     ;;;;            ..",
"  .;  . ;;;..;;  ;;;;;;;;;;;;;;  ;;    ;;;                        +;+:++;;               ;;;;                 ;;;       ;++;:;;*; ;. +++                                    ;;;;;;;       ;;;;;;; ;;;;",
"            ;.; ;;;;;;;;;;;;;;;;;;;;;;;;;;  ; ;;;;;               ;;; ..;;               ;;;;                           ;+;; ;;*; ;  +;+                                                       ;",
"       ;    ;:; ;:.        .:;  .                                 ;;; ;:;;               +;+;                 ;;        ;++; ;;*; ;  +++;;;;   ;;;            ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;",
"  .   .     ;;; ;;;; ..  .;;;; ;.. .  ..   .;  ;;;;               ;;+:;+;;               +;+;                 ;.;       ;+;;:;;*; ;  +++ .       ;                    ...;:.::: ......  .   .     .:. ;;",
"      ;;      ; ;;;        ;;;            ;;;                     ;;;;;;;;               ;;;;                 ;;;       ;+.; ;++; ;  +;;                             ;;;;;;;;;;;;;;;;; ;          ;;;;;;",
";;    ;; ;;;;;; ;;  ; ;    ;;; ;       ;                          ;;;;;;;;               ;;;;                 ; ;       ;+;;;;;+; ;  +;;         ;                 ;                   ;;;",
"  .   .   ...;; ;.   ..     .   :      .                          ;;+.;;;;               +;+;                ;;;;       ;++;:;+*; ;  +++         ;                                      .              .",
"         ;;;;;; ;;; ;;;;       ;;; ;;;;;;                         ;;;;;;;;               ;;;;;;;;;;;;;;;;;;; ;;;;       ;+;; ;;+; ;  +;;         ;                                   ;;;;;        ; ; ;",
";;;; ;       ;; ;;                         ;    ;;;  ;         ;; ;;.   ;;               ;; ....::..;:..::..    ;       ;;:; ;;+;    ;.;       ; ;                     ;;;;       ; ;      ;",
"      .      .; ;                                                 ;;+.:;;;                 ;;;;;;;;;;;;;;;;;     ;;;;;;;;;+;:;++;    ;;;        .;",
";;;;;;;;;;;;;;;  ;; ;;;         ;  ;;;;;  ;;    ;;;  ;;        ;; ;;; ..;;;;;;;;;;;;;;;;;;   ;;;;        ;;;;      ... . ;;; ;;+;    ;.;       ;;;                 ;                   ;;;;;;;;;; ;;  ;;",
"                                                                  ;;:    ;;+;;+++;;;;;;;;++;;;;;;;;;++;;;;;;;;;;;        ;:. ;;+;    ; ;",
];

// Mobile closeup (smaller, for phones)
const artMobile = [
"     ..                .......",
"     ..             . .,,..,..",
"     ..             ...,. ....",
"     ..             .....   ..",
"      .     .:::::, ..........",
"      .     .**##*+ ... . .,..",
"      .     .*#%%#*,....  ....",
"     ..   . .#%#*%*........  ,",
"     ..     .#%#:+#:  ....  ..",
"  .  ..     .%%*,:*,..  .....,",
"   . ..     .##;.:*:      .,.,",
"  .  ... .  .*:,.+*:.       .;,",
"  :,,,:,... ,#:.,+*,.  ....,:*;:",
",.+;:+*+:;;,,*;+***,. .::;+**%#*",
":,+++#%*++;::+...,*:,.;+*#%%%%%#",
";:*+*#%#+*;:;;.. .+::,+##%%%%%%#",
"+;#**#%#;++;:+,,,:*::;+*#%%%%%%*",
";:+**##*;;::,*+****:;;+*##%%%%#*",
". .,+##*;:..,;,. ,*:,.,:+*###%#+",
"  . *+*+**;,:;.. .+:,,:;;++++*+:",
"  . ::;:::,.:;.:::+,.,:,;;::;+:.",
",           .#####+      ,,,,:.",
";.......    .#####+   ........",
"++++;++;+;;:;;++++;:;++;;;:;::,,"
];

const matrixChars = "ﾊﾐﾋｰｳｼﾅﾓﾆｻﾜﾂｵﾘｱﾎﾃﾏｹﾒｴｶｷﾑﾕﾗｾﾈｽﾀﾇﾍ";

// Detect device
const isMobile = /iPhone|Android/i.test(navigator.userAgent) && window.innerWidth < 800;
console.log('Device:', isMobile ? 'mobile' : 'desktop', window.innerWidth, 'x', window.innerHeight);

// Font sizing
const fontSize = isMobile ? (window.innerWidth < 380 ? 8 : 10) : (window.innerWidth < 1200 ? 10 : 12);

const term = new Terminal({
    cursorBlink: true,
    cursorStyle: 'block',
    fontFamily: '"Glass TTY VT220", monospace',
    fontSize: fontSize,
    lineHeight: 1.0,
    scrollback: 500,
    theme: { background: '#020202', foreground: '#33ff33', cursor: '#33ff33' }
});

const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
term.open(document.getElementById('terminal'));
setTimeout(() => { fitAddon.fit(); console.log('Terminal:', term.cols, 'x', term.rows); runIntro(); }, 150);
window.addEventListener('resize', () => fitAddon.fit());

let socket = null, introComplete = false;
const sleep = ms => new Promise(r => setTimeout(r, ms));
const green = '\x1b[32m', bright = '\x1b[92m', white = '\x1b[97m', dim = '\x1b[2m\x1b[32m', reset = '\x1b[0m';
const randChar = () => matrixChars[Math.floor(Math.random() * matrixChars.length)];

async function runIntro() {
    const art = isMobile ? artMobile : artDesktop;
    const cols = term.cols;
    const rows = term.rows;
    console.log('Art:', isMobile ? 'mobile' : 'desktop', art[0].length, 'x', art.length, 'Terminal:', cols, 'x', rows);
    
    term.clear();
    
    // Use full terminal width for rain
    const rainW = cols;
    const rainH = rows - 1;
    
    // Initialize rain drops
    let drops = [];
    for (let x = 0; x < rainW; x++) {
        drops[x] = { y: Math.random() * rainH * 2 - rainH, speed: 1 + Math.random() * 2 };
    }
    
    // FAST rain - 30 frames, 25ms each = 750ms total
    for (let frame = 0; frame < 30; frame++) {
        term.write('\x1b[H'); // Home
        for (let y = 0; y < rainH; y++) {
            let line = '';
            for (let x = 0; x < rainW; x++) {
                let d = drops[x].y - y;
                if (d >= 0 && d < 1) line += white + randChar() + reset;
                else if (d >= 1 && d < 3) line += bright + randChar() + reset;
                else if (d >= 3 && d < 6) line += green + randChar() + reset;
                else line += ' ';
            }
            term.writeln(line);
        }
        // Update drops
        for (let x = 0; x < rainW; x++) {
            drops[x].y += drops[x].speed;
            if (drops[x].y > rainH + 6) {
                drops[x].y = -Math.random() * 6;
                drops[x].speed = 1 + Math.random() * 2;
            }
        }
        await sleep(25);
    }
    
    await sleep(100);
    term.clear();
    
    // Show art - clip to terminal width, show as many rows as fit
    const artH = art.length;
    const showRows = Math.min(artH, rows - 10);
    
    if (showRows > 10) {
        // Reveal line by line - FAST
        for (let y = 0; y < showRows; y++) {
            let line = '';
            const artLine = art[y] || '';
            // Only show what fits in terminal width
            for (let x = 0; x < Math.min(artLine.length, cols); x++) {
                let c = artLine[x];
                if (c === ' ') line += ' ';
                else if ('.,:'.includes(c)) line += dim + c + reset;
                else if (';+*'.includes(c)) line += green + c + reset;
                else if ('#%@'.includes(c)) line += bright + c + reset;
                else line += green + c + reset;
            }
            term.writeln(line);
            await sleep(12);
        }
        await sleep(400);
    }
    
    // Banner
    term.writeln('');
    const banner = 'T H E   C O N S T R U C T';
    const pad = Math.max(0, Math.floor((cols - banner.length) / 2));
    const lineW = Math.min(cols - 4, banner.length + 8);
    const linePad = Math.max(0, Math.floor((cols - lineW) / 2));
    
    term.writeln(' '.repeat(linePad) + white + '═'.repeat(lineW) + reset);
    term.writeln('');
    term.writeln(' '.repeat(pad) + bright + banner + reset);
    term.writeln(' '.repeat(pad) + green + banner + reset);
    term.writeln(' '.repeat(pad) + bright + banner + reset);
    term.writeln('');
    term.writeln(' '.repeat(linePad) + white + '═'.repeat(lineW) + reset);
    
    await sleep(2000);
    term.writeln('');
    term.writeln(green + '[ Connection established ]' + reset);
    
    introComplete = true;
    connect();
}

function connect() {
    if (socket && socket.readyState === WebSocket.OPEN) return;
    socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
    socket.onmessage = e => term.write(e.data);
    socket.onclose = () => { if (introComplete) { term.writeln('\x1b[31m[ Signal lost ]\x1b[0m'); setTimeout(connect, 3000); } };
}
document.addEventListener('visibilitychange', () => { if (!document.hidden && introComplete && (!socket || socket.readyState !== WebSocket.OPEN)) connect(); });

const input = document.getElementById('input');
function sendInput() { const t = input.value.trim(); if (t && socket && socket.readyState === WebSocket.OPEN) { term.write(t + '\r\n'); socket.send(t + '\n'); input.value = ''; } input.focus(); }
function cmd(s) { if (socket && socket.readyState === WebSocket.OPEN) { term.write(s + '\r\n'); socket.send(s + '\n'); } }
input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendInput(); } });

let line = '';
term.onKey(({ key, domEvent }) => {
    if (window.innerWidth < 600 || !introComplete || !socket || socket.readyState !== WebSocket.OPEN) return;
    if (domEvent.keyCode === 13) { term.write('\r\n'); socket.send(line + '\n'); line = ''; }
    else if (domEvent.keyCode === 8) { if (line.length > 0) { line = line.slice(0, -1); term.write('\b \b'); } }
    else if (!domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey) { line += key; term.write(key); }
});
document.getElementById('crt').addEventListener('click', () => { if (introComplete) connect(); });
</script>
</body>
</html>`
